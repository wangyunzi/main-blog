# $BOT_NAME $BOT_EMAIL $TOKEN_NAME $ACCESS_TOKEN $NOTION_TOKEN
# variables must be defined
# ...
pages:
  stage: deploy
  # ...

notion-sync:
  stage: deploy
  rules:
    # run this job just only if it was scheduled or triggered manually
    - if: ($CI_PIPELINE_SOURCE == "manual" || $CI_PIPELINE_SOURCE == "schedule") && $NOTION_TOKEN != null && $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH
  script:
    - |-
      # run our synchronization command
      bundle exec jekyll fetch_notion
      # if there are any changes from notion ...
      # note: be sure that all files produced by 
      #       (i.e. bundle install) are git-ignored
      if [[ $(git status --porcelain) ]]; then
        git config user.name $BOT_NAME
        git config user.email $BOT_EMAIL

        git add .
        git commit -m "Notion sync $(date +"%Y-%m-%d")"

        git remote add ci "https://$TOKEN_NAME:$ACCESS_TOKEN@gitlab.com/<username>/<your-repo>.git"
        git push ci HEAD:$CI_COMMIT_REF_NAME
      fi